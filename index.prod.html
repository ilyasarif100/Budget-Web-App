<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="accelerometer=*, encrypted-media=*">
    <title>Budget Tracker</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Favicon (data URI SVG to avoid 404) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</head>
<body>
    <!-- Top Dashboard Bar -->
    <header class="dashboard-header">
        <div class="dashboard-content">
            <div class="dashboard-item">
                <span class="dashboard-label">Current Month</span>
                <span class="dashboard-value" id="current-month">‚Äî</span>
            </div>
            <div class="dashboard-item">
                <span class="dashboard-label">Total Balance</span>
                <div class="dashboard-value-container">
                    <span class="dashboard-value balance" id="total-balance">$0.00</span>
                    <button class="btn-icon-small" id="edit-total-balance" aria-label="Edit total balance" title="Edit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="dashboard-item">
                <span class="dashboard-label">Total Spent</span>
                <div class="dashboard-value-container">
                    <span class="dashboard-value spent" id="total-spent">$0.00</span>
                    <button class="btn-icon-small" id="edit-total-spent" aria-label="Edit total spent" title="Edit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="dashboard-item accounts-section">
                <div class="dashboard-section-header">
                    <span class="dashboard-label">Accounts</span>
                    <div class="dashboard-section-actions">
                        <button class="btn-primary btn-small" id="add-account-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Account
                        </button>
                    </div>
                </div>
                <div class="dashboard-section-content" id="accounts-summary"></div>
            </div>
            <div class="dashboard-item categories-section">
                <div class="dashboard-section-header">
                    <span class="dashboard-label">Categories</span>
                    <div class="dashboard-section-actions">
                        <button class="btn-primary btn-small" id="add-category-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Category
                        </button>
                    </div>
                </div>
                <div class="dashboard-section-content" id="categories-summary"></div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <h3>Accounts</h3>
                    <div id="accounts-expanded"></div>
                </div>
                <div class="sidebar-section">
                    <h3>Budget Categories</h3>
                    <div id="categories-expanded"></div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Filters -->
            <div class="filters-container">
                <div class="filter-group">
                    <label for="filter-date-range">Date Range:</label>
                    <select id="filter-date-range">
                        <option value="current-month" selected>Current Month</option>
                        <option value="select-month">Select Month</option>
                        <option value="last-7-days">Last 7 Days</option>
                        <option value="last-30-days">Last 30 Days</option>
                        <option value="last-90-days">Last 90 Days</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="filter-group" id="month-select-group" style="display: none;">
                    <label for="filter-month">Month:</label>
                    <input type="month" id="filter-month">
                </div>
                <div class="filter-group" id="custom-date-group" style="display: none;">
                    <label for="filter-date-start">Start:</label>
                    <input type="date" id="filter-date-start">
                    <label for="filter-date-end">End:</label>
                    <input type="date" id="filter-date-end">
                </div>
                <div class="filter-group">
                    <label for="filter-category">Category:</label>
                    <select id="filter-category">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-status">Status:</label>
                    <select id="filter-status">
                        <option value="">All Status</option>
                        <option value="posted">Posted</option>
                        <option value="pending">Pending</option>
                        <option value="removed-system">Removed by System</option>
                        <option value="removed-user">Removed by Me</option>
                        <option value="removed-all">All Removed</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-account">Account:</label>
                    <select id="filter-account">
                        <option value="">All Accounts</option>
                    </select>
                </div>
            </div>

            <!-- Transactions Table -->
            <div class="table-container">
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="date">
                                Date <span class="sort-indicator"></span>
                            </th>
                            <th class="sortable" data-sort="merchant">
                                Merchant <span class="sort-indicator"></span>
                            </th>
                            <th class="sortable" data-sort="amount">
                                Amount <span class="sort-indicator"></span>
                            </th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Account</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- Transactions will be rendered here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <button class="btn-primary" id="sync-btn">
            <span id="sync-status-indicator"></span>
            <span id="sync-btn-text">Sync Transactions</span>
            <span id="sync-last-time"></span>
        </button>
        <button class="btn-secondary" id="export-btn">Export CSV / Excel</button>
    </footer>

    <!-- Modals -->
    <!-- Add/Edit Category Modal -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="category-modal-title">Add Category</h2>
                <button class="modal-close" id="close-category-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <div class="form-group">
                        <label for="category-name">Category Name</label>
                        <input type="text" id="category-name" required placeholder="e.g., Food, Rent, Entertainment">
                    </div>
                    <div class="form-group">
                        <label for="category-budget">Monthly Budget</label>
                        <input type="number" id="category-budget" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancel-category">Cancel</button>
                        <button type="submit" class="btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Account Modal -->
    <div class="modal" id="account-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="account-modal-title">Add Account</h2>
                <button class="modal-close" id="close-account-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="account-connection-options" style="margin-bottom: 1.5rem;">
                    <button type="button" class="btn-primary" id="connect-plaid-btn" style="width: 100%; margin-bottom: 0.75rem;">
                        Connect via Plaid
                    </button>
                    <button type="button" class="btn-secondary" id="manual-entry-btn" style="width: 100%;">
                        Manual Entry
                    </button>
                </div>
                <form id="account-form" style="display: none;">
                    <div class="form-group">
                        <label for="account-name">Account Name</label>
                        <input type="text" id="account-name" required placeholder="e.g., Chase Checking">
                    </div>
                    <div class="form-group">
                        <label for="account-type">Account Type</label>
                        <select id="account-type" required>
                            <option value="depository">Depository</option>
                            <option value="credit">Credit</option>
                            <option value="loan">Loan</option>
                            <option value="investment">Investment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="account-subtype">Account Subtype</label>
                        <select id="account-subtype" required>
                            <option value="checking">Checking</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="account-mask">Last 4 Digits</label>
                        <input type="text" id="account-mask" maxlength="4" pattern="[0-9]{4}" placeholder="1234">
                    </div>
                    <div class="form-group">
                        <label for="account-balance">Current Balance</label>
                        <input type="number" id="account-balance" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancel-account">Cancel</button>
                        <button type="submit" class="btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Plaid Modal -->
    <div class="modal" id="plaid-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Connect Bank Account</h2>
                <button class="modal-close" id="close-plaid-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="plaid-loading" style="text-align: center; padding: 2rem;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
                    <p style="margin-top: 1rem;">Loading Plaid Link...</p>
                </div>
                <div id="plaid-error" style="display: none; padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger-color); border-radius: var(--radius-md); color: var(--danger-color);"></div>
                <div id="plaid-link-container"></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Transaction Modal -->
    <div class="modal" id="transaction-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="transaction-modal-title">Add Transaction</h2>
                <button class="modal-close" id="close-transaction-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transaction-form">
                    <div class="form-group">
                        <label for="transaction-date">Date</label>
                        <input type="date" id="transaction-date" required>
                    </div>
                    <div class="form-group">
                        <label for="transaction-merchant">Merchant</label>
                        <input type="text" id="transaction-merchant" required placeholder="e.g., Amazon, Starbucks">
                    </div>
                    <div class="form-group">
                        <label for="transaction-amount">Amount</label>
                        <input type="number" id="transaction-amount" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="transaction-category">Category</label>
                        <select id="transaction-category">
                            <option value="">Exempt</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transaction-status">Status</label>
                        <select id="transaction-status" required>
                            <option value="posted">Posted</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transaction-account">Account</label>
                        <select id="transaction-account" required>
                            <option value="">Select Account</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transaction-notes">Notes</label>
                        <textarea id="transaction-notes" rows="3" placeholder="Add any notes about this transaction (optional)"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancel-transaction">Cancel</button>
                        <button type="submit" class="btn-primary">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Transaction Modal -->
    <div class="modal" id="delete-transaction-modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Delete Transaction</h2>
                <button class="modal-close" id="close-delete-transaction-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this transaction? This action cannot be undone.</p>
                <div id="delete-transaction-details" style="margin: 1rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);"></div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-delete-transaction">Cancel</button>
                    <button type="button" class="btn-danger" id="confirm-delete-transaction">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Total Balance Modal -->
    <div class="modal" id="edit-balance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Total Balance</h2>
                <button class="modal-close" id="close-edit-balance-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="custom-total-balance">Total Balance</label>
                    <input type="number" id="custom-total-balance" step="0.01" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">Include Accounts:</label>
                    <div id="balance-accounts-list"></div>
                    <div style="margin-top: 0.75rem;">
                        <button type="button" class="btn-link" id="select-all-accounts">Select All</button>
                        <span style="margin: 0 0.5rem;">|</span>
                        <button type="button" class="btn-link" id="deselect-all-accounts">Deselect All</button>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-edit-balance">Cancel</button>
                    <button type="button" class="btn-primary" id="save-edit-balance">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Total Spent Modal -->
    <div class="modal" id="edit-spent-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Total Spent</h2>
                <button class="modal-close" id="close-edit-spent-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">Include Categories:</label>
                    <div id="spent-categories-list"></div>
                    <div style="margin-top: 0.75rem;">
                        <button type="button" class="btn-link" id="select-all-categories">Select All</button>
                        <span style="margin: 0 0.5rem;">|</span>
                        <button type="button" class="btn-link" id="deselect-all-categories">Deselect All</button>
                    </div>
                </div>
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">Include Accounts:</label>
                    <div id="spent-accounts-list"></div>
                    <div style="margin-top: 0.75rem;">
                        <button type="button" class="btn-link" id="select-all-spent-accounts">Select All</button>
                        <span style="margin: 0 0.5rem;">|</span>
                        <button type="button" class="btn-link" id="deselect-all-spent-accounts">Deselect All</button>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="include-exempt-in-spent" style="width: auto;">
                        <span>Include exempt transactions</span>
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-edit-spent">Cancel</button>
                    <button type="button" class="btn-primary" id="save-edit-spent">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Clear All Data Modal -->
    <div class="modal" id="clear-data-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2>Clear All Data</h2>
                <button class="modal-close" id="close-clear-data-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--danger-color); font-weight: 600; margin-bottom: 1rem;">‚ö†Ô∏è Warning: This action cannot be undone!</p>
                <p>This will permanently delete:</p>
                <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                    <li>All transactions</li>
                    <li>All accounts</li>
                    <li>All categories</li>
                    <li>All Plaid connections</li>
                    <li>All saved preferences</li>
                </ul>
                <p>Are you absolutely sure you want to proceed?</p>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-clear-data">Cancel</button>
                    <button type="button" class="btn-danger" id="confirm-clear-data">Yes, Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Accounts Selection Modal -->
    <div class="modal" id="sync-accounts-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Accounts to Sync</h2>
                <button class="modal-close" id="close-sync-accounts-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="sync-accounts-list"></div>
                <div style="margin-top: 1rem;">
                    <button type="button" class="btn-link" id="select-all-sync-accounts">Select All</button>
                    <span style="margin: 0 0.5rem;">|</span>
                    <button type="button" class="btn-link" id="deselect-all-sync-accounts">Deselect All</button>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-sync-accounts">Cancel</button>
                    <button type="button" class="btn-primary" id="confirm-sync-accounts">Sync Selected</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div class="modal" id="auth-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="auth-modal-title">Login</h2>
                <button class="modal-close" id="close-auth-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="auth-form">
                    <div class="form-group">
                        <label for="auth-email">Email</label>
                        <input type="email" id="auth-email" required autocomplete="email" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="auth-password">Password</label>
                        <input type="password" id="auth-password" required autocomplete="current-password" placeholder="Enter your password">
                    </div>
                    <div id="auth-error" style="display: none; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger-color); border-radius: var(--radius-md); margin-bottom: 1rem; color: var(--danger-color); font-size: 0.875rem;"></div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="auth-switch-mode">Need to register?</button>
                        <button type="submit" class="btn-primary" id="auth-submit">Login</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Production: Minified bundle -->
    <script src="config.js"></script>
    <script src="dist/app.min.js"></script>
    <!-- Plaid SDK loaded lazily when needed -->
</body>
</html>

